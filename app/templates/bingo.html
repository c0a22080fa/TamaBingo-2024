{% extends "base.html" %}

{% block title %}ビンゴページ{% endblock %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>デジタルビンゴ - Enjoy Tama with Bingo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bingo.css') }}">
</head>
<h1>ビンゴシート</h1>

<!-- カメラ起動ボタンをビンゴシートの上に移動 -->
<button id="start-camera">カメラを起動する</button>

<!-- ビンゴシートを大枠で囲む -->
<div id="bingo-wrapper">
  <table id="bingo-table">
      {% for i in range(1, 4) %}
      <tr>
          {% for j in range(1, 4) %}
          <td id="cell-{{ (i-1)*3 + j }}">未チェック</td>
          {% endfor %}
      </tr>
      {% endfor %}
  </table>
</div>

<br>

<div id="qr-reader"></div>

<script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
<script>
    document.getElementById('start-camera').addEventListener('click', function() {
        const qrCodeReader = new Html5Qrcode("qr-reader");
        qrCodeReader.start({ facingMode: "environment" }, {
            fps: 10,
            qrbox: 250
        },
        qrCodeMessage => {
            // QRコードがスキャンされたときの処理
            console.log(`QRコードが読み取られました: ${qrCodeMessage}`);
            // サーバーにQRコードの情報を送信して、ビンゴシートを更新
            fetch(`/stamp/${qrCodeMessage}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const cellId = data.cell_id;
                        document.getElementById(`cell-${cellId}`).textContent = 'チェック済み';
                    } else {
                        alert('無効なQRコードです');
                    }
                })
                .catch(error => console.error('エラー:', error));
        },
        errorMessage => {
            console.warn(`QRコード読み取りエラー: ${errorMessage}`);
        });
    });
</script>
{% endblock %}