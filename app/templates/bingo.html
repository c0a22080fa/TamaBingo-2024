{% extends "base.html" %}

{% block title %}ビンゴページ{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ビンゴシート</title>
    <!-- Include the QR code scanner library -->
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
</head>
<body>
    <h1>ビンゴシート</h1>
    <table id="bingo-table">
        {% for i in range(1, 4) %}
        <tr>
            {% for j in range(1, 4) %}
            <td id="cell-{{ (i-1)*3 + j }}">未チェック</td>
            {% endfor %}
        </tr>
        {% endfor %}
    </table>
    <br>
    <button id="start-camera">カメラを起動する</button>
    <div id="qr-reader" style="width: 500px;"></div>
    <br>
    <a href='/index'>
        <button>QRコード一覧に戻る</button>
    </a>

    <script>
        document.getElementById('start-camera').addEventListener('click', function() {
            const qrCodeReader = new Html5Qrcode("qr-reader");
            qrCodeReader.start({ facingMode: "environment" }, {
                fps: 10,
                qrbox: 250
            },
            qrCodeMessage => {
                // QRコードがスキャンされたときの処理
                console.log(`QRコードが読み取られました: ${qrCodeMessage}`);
                // サーバーにQRコードの情報を送信して、ビンゴシートを更新
                fetch(`/stamp/${qrCodeMessage}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            const cellId = data.cell_id;
                            document.getElementById(`cell-${cellId}`).textContent = 'チェック済み';
                        } else {
                            alert('無効なQRコードです');
                        }
                    })
                    .catch(error => console.error('エラー:', error));
            },
            errorMessage => {
                console.warn(`QRコード読み取りエラー: ${errorMessage}`);
            });
        });
    </script>
</body>
</html>
    {% endblock %}